# System Architecture Specification

## Feature Name
Full-Stack Todo Web Application - System Architecture

## Purpose
Define the overall system architecture, component interactions, technology stack, and deployment strategy for the Phase II web application. This specification serves as the foundation for all backend and frontend feature specifications.

## Overview

The Todo Web Application follows a three-tier architecture:
1. **Presentation Layer**: Next.js frontend (React-based SPA)
2. **Application Layer**: FastAPI backend (RESTful API)
3. **Data Layer**: PostgreSQL database (Neon Serverless)

### Architecture Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                        CLIENT TIER                          │
│  ┌───────────────────────────────────────────────────────┐  │
│  │              Next.js Frontend (Vercel)                │  │
│  │  - React Components (TypeScript)                      │  │
│  │  - Tailwind CSS Styling                               │  │
│  │  - API Client (Fetch/Axios)                           │  │
│  │  - Client-side Validation                             │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTPS/REST
                            │ JSON
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      APPLICATION TIER                       │
│  ┌───────────────────────────────────────────────────────┐  │
│  │           FastAPI Backend (Railway/Render)            │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  Routers (HTTP Endpoints)                       │  │  │
│  │  │  - /api/v1/tasks                                │  │  │
│  │  │  - /api/v1/categories                           │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  Schemas (Pydantic Validation)                  │  │  │
│  │  │  - Request/Response Models                      │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  CRUD Operations (Business Logic)               │  │  │
│  │  │  - Task Management                              │  │  │
│  │  │  - Search & Filter                              │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │  Models (SQLModel/ORM)                          │  │  │
│  │  │  - Database Schema                              │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ PostgreSQL Protocol
                            │ SQL Queries
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                         DATA TIER                           │
│  ┌───────────────────────────────────────────────────────┐  │
│  │        PostgreSQL Database (Neon Serverless)          │  │
│  │  - Tasks Table                                        │  │
│  │  - Categories Table (future)                          │  │
│  │  - Indexes & Constraints                              │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## Technology Stack

### Frontend (Presentation Layer)
- **Framework**: Next.js 14+ with App Router
- **Language**: TypeScript 5+ (strict mode)
- **UI Library**: React 18+
- **Styling**: Tailwind CSS 3+
- **HTTP Client**: Native Fetch API
- **Form Handling**: React Hook Form (optional)
- **Date Picker**: react-datepicker
- **Icons**: Lucide React
- **Deployment**: Vercel

### Backend (Application Layer)
- **Framework**: FastAPI 0.109+
- **Language**: Python 3.11+
- **ORM**: SQLModel 0.0.14+
- **Validation**: Pydantic v2
- **Database Driver**: psycopg2 or asyncpg
- **Migrations**: Alembic
- **ASGI Server**: Uvicorn
- **Deployment**: Railway, Render, or local

### Database (Data Layer)
- **Database**: PostgreSQL 15+
- **Hosting**: Neon Serverless
- **Connection**: Connection pooling via SQLModel
- **Backups**: Managed by Neon

### Development Tools
- **Backend**: UV (package manager), Black (formatter), Ruff (linter), Pytest (testing)
- **Frontend**: npm/pnpm (package manager), ESLint (linter), Prettier (formatter), Jest (testing)
- **Version Control**: Git + GitHub
- **API Testing**: Swagger UI (auto-generated by FastAPI)

## Component Interactions

### Request Flow (Create Task Example)

1. **User Action**: User fills out task form and clicks "Add Task"
2. **Frontend Validation**: React Hook Form validates inputs client-side
3. **API Request**: Frontend sends POST request to `/api/v1/tasks`
   ```typescript
   POST /api/v1/tasks
   Content-Type: application/json

   {
     "title": "Buy groceries",
     "description": "Milk, eggs, bread",
     "priority": "high",
     "due_date": "2026-01-25T10:00:00Z"
   }
   ```
4. **Backend Router**: FastAPI router receives request
5. **Schema Validation**: Pydantic validates request body
6. **CRUD Operation**: CRUD function creates task in database
7. **Database Insert**: SQLModel executes INSERT query
8. **Response**: Backend returns created task with 201 status
   ```json
   {
     "data": {
       "id": "550e8400-e29b-41d4-a716-446655440000",
       "title": "Buy groceries",
       "description": "Milk, eggs, bread",
       "status": false,
       "priority": "high",
       "category": null,
       "due_date": "2026-01-25T10:00:00Z",
       "created_at": "2026-01-24T15:30:00Z",
       "updated_at": "2026-01-24T15:30:00Z"
     },
     "message": "Task created successfully"
   }
   ```
9. **Frontend Update**: Frontend updates UI with new task
10. **User Feedback**: Success message displayed to user

### Error Flow (Validation Error Example)

1. **User Action**: User submits form with empty title
2. **Frontend Validation**: Catches error, shows inline message
3. **If bypassed**: API Request sent to backend
4. **Backend Validation**: Pydantic catches validation error
5. **Error Response**: Backend returns 422 status
   ```json
   {
     "detail": "Validation error",
     "errors": [
       {
         "field": "title",
         "message": "Title is required and cannot be empty"
       }
     ]
   }
   ```
6. **Frontend Error Handling**: Displays error message to user
7. **User Feedback**: Clear error message with recovery suggestion

## Data Flow

### State Management Strategy

#### Server State (Backend Data)
- **Source of Truth**: PostgreSQL database
- **Caching**: Optional (React Query or SWR for frontend caching)
- **Synchronization**: Fetch on mount, refetch after mutations
- **Optimistic Updates**: Update UI immediately, rollback on error

#### UI State (Frontend Only)
- **Form State**: Managed by React Hook Form or local component state
- **Modal State**: Local component state
- **Filter State**: URL query parameters (shareable, bookmarkable)
- **Sort State**: URL query parameters

### Data Synchronization

```
User Action → Frontend State Update → API Call → Backend Processing
                    ↓                                      ↓
            Optimistic UI Update                   Database Update
                    ↓                                      ↓
            Wait for Response ← ← ← ← ← ← ← ← ← Response Sent
                    ↓
            Confirm or Rollback
```

## API Design

### Base URL
- **Development**: `http://localhost:8000/api/v1`
- **Production**: `https://your-backend.railway.app/api/v1`

### Endpoints Overview

#### Tasks Resource
- `GET /tasks` - List all tasks (with filtering, sorting, pagination)
- `POST /tasks` - Create new task
- `GET /tasks/{id}` - Get single task
- `PUT /tasks/{id}` - Update entire task
- `PATCH /tasks/{id}` - Partial update task
- `DELETE /tasks/{id}` - Delete task
- `PATCH /tasks/{id}/complete` - Mark task complete
- `PATCH /tasks/{id}/incomplete` - Mark task incomplete

#### Categories Resource (Future)
- `GET /categories` - List all categories
- `POST /categories` - Create new category
- `GET /categories/{id}` - Get single category
- `PUT /categories/{id}` - Update category
- `DELETE /categories/{id}` - Delete category

### API Conventions

#### Request Headers
```
Content-Type: application/json
Accept: application/json
```

#### Response Format (Success)
```json
{
  "data": { /* resource or array */ },
  "message": "Operation successful"
}
```

#### Response Format (Error)
```json
{
  "detail": "Human-readable error message",
  "errors": [
    {
      "field": "field_name",
      "message": "Specific error message"
    }
  ]
}
```

#### Pagination (Query Parameters)
```
?page=1&limit=20
```

#### Filtering (Query Parameters)
```
?status=incomplete&priority=high&category=work
```

#### Sorting (Query Parameters)
```
?sort=due_date&order=asc
```

#### Search (Query Parameter)
```
?search=groceries
```

## Database Design

### Schema Overview

#### Tasks Table
```sql
CREATE TABLE tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(200) NOT NULL,
    description TEXT,
    status BOOLEAN NOT NULL DEFAULT FALSE,
    priority VARCHAR(10) NOT NULL DEFAULT 'medium',
    category VARCHAR(50),
    due_date TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),

    CONSTRAINT priority_check CHECK (priority IN ('high', 'medium', 'low'))
);

CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_priority ON tasks(priority);
CREATE INDEX idx_tasks_due_date ON tasks(due_date);
CREATE INDEX idx_tasks_category ON tasks(category);
CREATE INDEX idx_tasks_created_at ON tasks(created_at);
```

### Data Types Rationale
- **UUID**: Better for distributed systems, no sequential ID leakage
- **VARCHAR(200)**: Reasonable limit for task titles
- **TEXT**: Unlimited description length
- **BOOLEAN**: Clear true/false for completion status
- **VARCHAR(10)**: Enum-like constraint for priority
- **TIMESTAMP WITH TIME ZONE**: Proper timezone handling

### Indexes Rationale
- **status**: Frequently filtered (complete/incomplete)
- **priority**: Frequently filtered and sorted
- **due_date**: Frequently sorted and filtered
- **category**: Frequently filtered
- **created_at**: Default sort order

## Security Architecture

### CORS Configuration
```python
# Backend CORS settings
origins = [
    "http://localhost:3000",  # Development
    "https://your-app.vercel.app",  # Production
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### Environment Variables

#### Backend (.env)
```
DATABASE_URL=postgresql://user:password@host/database
CORS_ORIGINS=http://localhost:3000,https://your-app.vercel.app
ENVIRONMENT=development
```

#### Frontend (.env.local)
```
NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1
```

### Security Measures
1. **Input Validation**: Pydantic schemas validate all inputs
2. **SQL Injection Prevention**: SQLModel uses parameterized queries
3. **XSS Prevention**: React escapes output by default
4. **CORS**: Restricted to specific origins
5. **HTTPS**: Required in production
6. **Rate Limiting**: Consider implementing for production
7. **Secrets Management**: Environment variables, never committed

## Deployment Architecture

### Frontend Deployment (Vercel)
```
GitHub Repository → Vercel Auto-Deploy
                    ↓
                Build Next.js App
                    ↓
                Deploy to CDN
                    ↓
                https://your-app.vercel.app
```

**Configuration**:
- Framework: Next.js
- Build Command: `npm run build`
- Output Directory: `.next`
- Environment Variables: `NEXT_PUBLIC_API_URL`

### Backend Deployment (Railway/Render)
```
GitHub Repository → Railway/Render Auto-Deploy
                    ↓
                Install Dependencies (UV)
                    ↓
                Run Migrations (Alembic)
                    ↓
                Start Uvicorn Server
                    ↓
                https://your-backend.railway.app
```

**Configuration**:
- Start Command: `uvicorn src.main:app --host 0.0.0.0 --port $PORT`
- Environment Variables: `DATABASE_URL`, `CORS_ORIGINS`

### Database Setup (Neon)
1. Create Neon project
2. Create database
3. Copy connection string
4. Add to backend environment variables
5. Run migrations

## Development Workflow

### Local Development Setup

#### Backend
```bash
cd backend
uv venv
source .venv/bin/activate  # or .venv\Scripts\activate on Windows
uv pip install -r requirements.txt
cp .env.example .env
# Edit .env with database URL
alembic upgrade head
uvicorn src.main:app --reload
```

#### Frontend
```bash
cd frontend
npm install
cp .env.local.example .env.local
# Edit .env.local with API URL
npm run dev
```

### Testing Strategy

#### Backend Testing
- **Unit Tests**: Test CRUD functions, validation logic
- **Integration Tests**: Test API endpoints with test database
- **Run**: `pytest tests/`

#### Frontend Testing
- **Component Tests**: Test UI components
- **Integration Tests**: Test API integration (mocked)
- **Run**: `npm test`

### Git Workflow
1. Create feature branch: `git checkout -b feature/task-crud`
2. Implement backend (spec → code → test)
3. Commit backend: `git commit -m "feat(backend): implement task CRUD API"`
4. Implement frontend (spec → code → test)
5. Commit frontend: `git commit -m "feat(frontend): implement task list UI"`
6. Push and create PR: `git push origin feature/task-crud`

## Performance Considerations

### Backend Performance
- **Database Connection Pooling**: Reuse connections
- **Query Optimization**: Use indexes, avoid N+1 queries
- **Pagination**: Limit result sets (default 20 items)
- **Caching**: Consider Redis for frequently accessed data (future)

### Frontend Performance
- **Code Splitting**: Lazy load routes and components
- **Image Optimization**: Use Next.js Image component
- **Debouncing**: Debounce search inputs (300ms)
- **Optimistic Updates**: Update UI before API response
- **Virtualization**: Virtualize long task lists (future)

## Monitoring & Observability

### Backend Logging
- Log all API requests (method, path, status, duration)
- Log all errors with stack traces
- Use structured logging (JSON format)

### Frontend Error Tracking
- Console errors in development
- Consider Sentry for production error tracking

### Health Checks
- Backend: `GET /health` endpoint
- Database: Connection check in health endpoint

## Acceptance Criteria

### System Architecture
- [ ] Three-tier architecture clearly defined
- [ ] Component interactions documented
- [ ] Technology stack specified
- [ ] API design conventions established
- [ ] Database schema designed
- [ ] Security measures defined
- [ ] Deployment strategy documented

### Technical Requirements
- [ ] Backend uses FastAPI with SQLModel
- [ ] Frontend uses Next.js with TypeScript
- [ ] Database is PostgreSQL (Neon)
- [ ] API follows REST principles
- [ ] CORS properly configured
- [ ] Environment variables used for configuration

### Documentation
- [ ] Architecture diagram included
- [ ] Request/response examples provided
- [ ] Database schema documented
- [ ] Deployment instructions clear
- [ ] Development setup documented

## Dependencies
- None (this is the foundational specification)

## Related Specifications
- `01-database-schema.md` - Detailed database design
- `02-api-design.md` - Complete API endpoint specifications
- Backend feature specifications in `specs/backend/`
- Frontend feature specifications in `specs/frontend/`

## Notes
- This architecture supports future enhancements (authentication, real-time updates, etc.)
- Stateless backend enables horizontal scaling
- Frontend and backend can be developed in parallel once API contract is defined
- Database migrations ensure schema versioning and rollback capability

---

**Version**: 1.0.0
**Created**: 2026-01-24
**Status**: Draft
**Author**: System Architect
